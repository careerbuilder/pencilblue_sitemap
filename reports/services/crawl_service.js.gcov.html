<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">

<html lang="en">

<head>
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  <title>LCOV - lcov.info - services/crawl_service.js</title>
  <link rel="stylesheet" type="text/css" href="../gcov.css">
</head>

<body>

  <table width="100%" border=0 cellspacing=0 cellpadding=0>
    <tr><td class="title">LCOV - code coverage report</td></tr>
    <tr><td class="ruler"><img src="../glass.png" width=3 height=3 alt=""></td></tr>

    <tr>
      <td width="100%">
        <table cellpadding=1 border=0 width="100%">
          <tr>
            <td width="10%" class="headerItem">Current view:</td>
            <td width="35%" class="headerValue"><a href="../index.html">top level</a> - <a href="index.html">services</a> - crawl_service.js<span style="font-size: 80%;"> (source / <a href="crawl_service.js.func-sort-c.html">functions</a>)</span></td>
            <td width="5%"></td>
            <td width="15%"></td>
            <td width="10%" class="headerCovTableHead">Hit</td>
            <td width="10%" class="headerCovTableHead">Total</td>
            <td width="15%" class="headerCovTableHead">Coverage</td>
          </tr>
          <tr>
            <td class="headerItem">Test:</td>
            <td class="headerValue">lcov.info</td>
            <td></td>
            <td class="headerItem">Lines:</td>
            <td class="headerCovTableEntry">57</td>
            <td class="headerCovTableEntry">59</td>
            <td class="headerCovTableEntryHi">96.6 %</td>
          </tr>
          <tr>
            <td class="headerItem">Date:</td>
            <td class="headerValue">2015-04-23 09:05:31</td>
            <td></td>
            <td class="headerItem">Functions:</td>
            <td class="headerCovTableEntry">18</td>
            <td class="headerCovTableEntry">19</td>
            <td class="headerCovTableEntryHi">94.7 %</td>
          </tr>
          <tr><td><img src="../glass.png" width=3 height=3 alt=""></td></tr>
        </table>
      </td>
    </tr>

    <tr><td class="ruler"><img src="../glass.png" width=3 height=3 alt=""></td></tr>
  </table>

  <table cellpadding=0 cellspacing=0 border=0>
    <tr>
      <td><br></td>
    </tr>
    <tr>
      <td>
<pre class="sourceHeading">          Line data    Source code</pre>
<pre class="source">
<a name="1"><span class="lineNum">       1 </span><span class="lineCov">          1 : module.exports = function CrawlServiceModule(pb){</span></a>
<span class="lineNum">       2 </span><span class="lineCov">          1 :     var Crawler = require('simplecrawler');</span>
<span class="lineNum">       3 </span><span class="lineCov">          1 :     var LINQ = require('node-linq').LINQ;</span>
<span class="lineNum">       4 </span><span class="lineCov">          1 :     var pluginService = new pb.PluginService();</span>
<span class="lineNum">       5 </span><span class="lineCov">          1 :     var pages = [];</span>
<span class="lineNum">       6 </span>            : 
<span class="lineNum">       7 </span>            :     /**
<a name="8"><span class="lineNum">       8 </span>            :      * Service for access to careerbuilder Job APIs</a>
<span class="lineNum">       9 </span>            :     */
<span class="lineNum">      10 </span><span class="lineCov">          1 :     function CrawlService() {}</span>
<span class="lineNum">      11 </span>            : 
<span class="lineNum">      12 </span>            : 
<span class="lineNum">      13 </span>            :     /**
<span class="lineNum">      14 </span>            :      * This function is called when the service is being setup by the system.  It is
<span class="lineNum">      15 </span>            :      * responsible for any setup that is needed when first created.  The services
<span class="lineNum">      16 </span>            :      * are all instantiated at once and are not added to the platform untill all
<span class="lineNum">      17 </span>            :      * initialization is complete.  Relying on other plugin services in the
<span class="lineNum">      18 </span>            :      * initialization could result in failure.
<span class="lineNum">      19 </span>            :      *
<span class="lineNum">      20 </span>            :      * @static
<span class="lineNum">      21 </span>            :      * @method init
<span class="lineNum">      22 </span>            :      * @param cb A callback that should provide one argument: cb(error) or cb(null)
<a name="23"><span class="lineNum">      23 </span>            :      * if initialization proceeded successfully.</a>
<span class="lineNum">      24 </span>            :      */
<span class="lineNum">      25 </span><span class="lineCov">          1 :     CrawlService.init = function(cb) {</span>
<span class="lineNum">      26 </span><span class="lineCov">          1 :         pb.log.debug(&quot;CrawlService: Initialized&quot;);</span>
<span class="lineNum">      27 </span><span class="lineCov">          1 :         cb(null, true);</span>
<span class="lineNum">      28 </span>            :     };
<span class="lineNum">      29 </span>            : 
<span class="lineNum">      30 </span>            :     /**
<span class="lineNum">      31 </span>            :      * A service interface function designed to allow developers to name the handle
<span class="lineNum">      32 </span>            :      * to the service object what ever they desire. The function must return a
<span class="lineNum">      33 </span>            :      * valid string and must not conflict with the names of other services for the
<span class="lineNum">      34 </span>            :      * plugin that the service is associated with.
<span class="lineNum">      35 </span>            :      *
<span class="lineNum">      36 </span>            :      * @static
<span class="lineNum">      37 </span>            :      * @method getName
<a name="38"><span class="lineNum">      38 </span>            :      * @return {String} The service name</a>
<span class="lineNum">      39 </span>            :      */
<span class="lineNum">      40 </span><span class="lineCov">          1 :     CrawlService.getName = function() {</span>
<span class="lineNum">      41 </span><span class="lineCov">          1 :         return &quot;crawlService&quot;;</span>
<a name="42"><span class="lineNum">      42 </span>            :     };</a>
<span class="lineNum">      43 </span>            : 
<a name="44"><span class="lineNum">      44 </span><span class="lineCov">          1 :     CrawlService.prototype.crawlSite = function(hostname, cb){</span></a>
<a name="45"><span class="lineNum">      45 </span><span class="lineCov">          1 :         pages.splice(0, pages.length);</span></a>
<span class="lineNum">      46 </span><span class="lineCov">          1 :         loadSettings(function(pluginPaths, excludedCrawlPaths, excludedSiteMapPaths){</span>
<span class="lineNum">      47 </span><span class="lineCov">          1 :             pluginPaths.forEach(function(path){</span>
<span class="lineNum">      48 </span><span class="lineCov">          2 :                 var siteRoot = hostname.replace('http://', '').replace('https://','').replace('/', '').replace(':8080','');</span>
<span class="lineNum">      49 </span><span class="lineCov">          2 :                 var myCrawler = new Crawler(siteRoot, path);</span>
<a name="50"><span class="lineNum">      50 </span><span class="lineCov">          2 :                 myCrawler.initialPort = pb.config.sitePort;</span></a>
<span class="lineNum">      51 </span><span class="lineCov">          2 :                 myCrawler.maxConcurrency = pb.config.crawler.maxConcurrency;</span>
<span class="lineNum">      52 </span><span class="lineCov">          2 :                 var conditionID = myCrawler.addFetchCondition(function(parsedURL) {</span>
<a name="53"><span class="lineNum">      53 </span><span class="lineNoCov">          0 :                     return pathIsNotAFile(parsedURL.path) &amp;&amp; listDoesNotContainItem(excludedCrawlPaths, parsedURL.path);</span></a>
<span class="lineNum">      54 </span>            :                 });
<span class="lineNum">      55 </span><span class="lineCov">          2 :                 myCrawler.on(&quot;fetchcomplete&quot;,function(queueItem, data, res){</span>
<span class="lineNum">      56 </span><span class="lineCov">         38 :                     var myPath = stripQueryString(queueItem.path);</span>
<span class="lineNum">      57 </span><span class="lineCov">         38 :                     var url = stripQueryString(queueItem.url);</span>
<span class="lineNum">      58 </span><span class="lineCov">         38 :                     if(pathIsNotAFile(myPath) &amp;&amp; listDoesNotContainItem(excludedSiteMapPaths, myPath) &amp;&amp; urlIsNotAlreadyInSiteMap(url)){</span>
<span class="lineNum">      59 </span><span class="lineCov">          3 :                         pages.push({</span>
<span class="lineNum">      60 </span>            :                             url: url,
<span class="lineNum">      61 </span>            :                             priority: getPagePriority(queueItem)
<span class="lineNum">      62 </span>            :                         });
<a name="63"><span class="lineNum">      63 </span>            :                     }</a>
<span class="lineNum">      64 </span>            :                 });
<span class="lineNum">      65 </span><span class="lineCov">          2 :                 myCrawler.on(&quot;complete&quot;, function(){</span>
<span class="lineNum">      66 </span><span class="lineCov">          2 :                     pb.log.silly(&quot;Crawling from &quot; + path + &quot; Complete&quot;);</span>
<span class="lineNum">      67 </span><span class="lineCov">          2 :                     if(path === pluginPaths[pluginPaths.length - 1]){</span>
<span class="lineNum">      68 </span><span class="lineCov">          1 :                         pb.log.silly(&quot;Crawling all paths Complete&quot;);</span>
<span class="lineNum">      69 </span><span class="lineCov">          1 :                         pb.log.silly(&quot;Crawler found &quot; + pages.length + &quot; pages&quot;);</span>
<span class="lineNum">      70 </span><span class="lineCov">          1 :                         cb(pages);</span>
<span class="lineNum">      71 </span>            :                     }
<span class="lineNum">      72 </span>            :                 });
<span class="lineNum">      73 </span><span class="lineCov">          2 :                 myCrawler.start();</span>
<span class="lineNum">      74 </span>            :             });
<span class="lineNum">      75 </span>            :         });
<span class="lineNum">      76 </span>            :     };
<a name="77"><span class="lineNum">      77 </span>            : </a>
<span class="lineNum">      78 </span>            :     //PRIVATE
<span class="lineNum">      79 </span><span class="lineCov">          1 :     function pathIsNotAFile(path){</span>
<a name="80"><span class="lineNum">      80 </span><span class="lineCov">         38 :         return path.match(/^[^.]+$|\.(?!(js|css|woff|tff|ttf|svg|eot|ico|jpg|png|bmp|gif|xml|json)$)([^.]+$)/);</span></a>
<a name="81"><span class="lineNum">      81 </span>            :     }</a>
<span class="lineNum">      82 </span><span class="lineCov">          1 :     function urlIsNotAlreadyInSiteMap(url){</span>
<span class="lineNum">      83 </span><span class="lineCov">          6 :         var queryResult = new LINQ(pages).Where(function(page){</span>
<span class="lineNum">      84 </span><span class="lineCov">         12 :             return page.url === url;</span>
<span class="lineNum">      85 </span>            :         }).ToArray();
<span class="lineNum">      86 </span><span class="lineCov">          6 :         var notInList = queryResult.length === 0;</span>
<span class="lineNum">      87 </span><span class="lineCov">          6 :         return notInList;</span>
<a name="88"><span class="lineNum">      88 </span>            :     }</a>
<a name="89"><span class="lineNum">      89 </span>            : </a>
<span class="lineNum">      90 </span><span class="lineCov">          1 :     function listDoesNotContainItem(list, item){</span>
<span class="lineNum">      91 </span><span class="lineCov">         10 :         var listcontaining_item = new LINQ(list).Where(function(myItem){</span>
<span class="lineNum">      92 </span><span class="lineCov">         20 :             return item.indexOf(myItem) &gt; -1;</span>
<span class="lineNum">      93 </span>            :         }).ToArray().length === 0;
<span class="lineNum">      94 </span><span class="lineCov">         10 :         return listcontaining_item;</span>
<a name="95"><span class="lineNum">      95 </span>            :     }</a>
<span class="lineNum">      96 </span>            : 
<span class="lineNum">      97 </span><span class="lineCov">          1 :     function stripQueryString(url){</span>
<span class="lineNum">      98 </span><span class="lineCov">         76 :         if(url.indexOf(&quot;?&quot;) &gt; -1){</span>
<span class="lineNum">      99 </span><span class="lineNoCov">          0 :              return url.substr(0, url.indexOf(&quot;?&quot;));</span>
<span class="lineNum">     100 </span>            :         }
<span class="lineNum">     101 </span><span class="lineCov">         76 :         return url;</span>
<a name="102"><span class="lineNum">     102 </span>            :     }</a>
<span class="lineNum">     103 </span>            : 
<span class="lineNum">     104 </span><span class="lineCov">          1 :     function getPagePriority(queueItem){</span>
<span class="lineNum">     105 </span><span class="lineCov">          3 :         if(queueItem.path.indexOf('/job/') === 0){</span>
<span class="lineNum">     106 </span><span class="lineCov">          1 :             return 0.5;</span>
<span class="lineNum">     107 </span>            :         }
<span class="lineNum">     108 </span><span class="lineCov">          2 :         else if(queueItem.path === '/'){</span>
<span class="lineNum">     109 </span><span class="lineCov">          1 :             return 1.0;</span>
<span class="lineNum">     110 </span>            :         }
<span class="lineNum">     111 </span><span class="lineCov">          1 :         return 0.3;</span>
<a name="112"><span class="lineNum">     112 </span>            :     }</a>
<a name="113"><span class="lineNum">     113 </span>            : </a>
<span class="lineNum">     114 </span><span class="lineCov">          1 :     function loadSettings(cb){</span>
<span class="lineNum">     115 </span><span class="lineCov">          1 :       pluginService.getSettingsKV('pencilblue_sitemap', function(err, siteMapSettings){</span>
<span class="lineNum">     116 </span><span class="lineCov">          1 :         var pluginPaths = siteMapSettings['crawl_paths_csv'].split(','),</span>
<span class="lineNum">     117 </span>            :           excludedCrawlPaths = siteMapSettings['ignore_path_csv'].split(','),
<span class="lineNum">     118 </span>            :           excludedSiteMapPaths = siteMapSettings['exclude_sitemap_path_csv'].split(',');
<span class="lineNum">     119 </span><span class="lineCov">          1 :         cb(pluginPaths, excludedCrawlPaths, excludedSiteMapPaths);</span>
<span class="lineNum">     120 </span>            :       });
<span class="lineNum">     121 </span>            :     }
<span class="lineNum">     122 </span>            : 
<span class="lineNum">     123 </span><span class="lineCov">          1 :     return CrawlService;</span>
<span class="lineNum">     124 </span>            : };
</pre>
      </td>
    </tr>
  </table>
  <br>

  <table width="100%" border=0 cellspacing=0 cellpadding=0>
    <tr><td class="ruler"><img src="../glass.png" width=3 height=3 alt=""></td></tr>
    <tr><td class="versionInfo">Generated by: <a href="http://ltp.sourceforge.net/coverage/lcov.php" target="_parent">LCOV version 1.11</a></td></tr>
  </table>
  <br>

</body>
</html>
